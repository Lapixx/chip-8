<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>CHIP-8</title>
    <script type="text/javascript" src="index.js"></script>
  </head>
  <body>
    <canvas id="cvs"></canvas>
    <script type="text/javascript">
      const width = 64
      const height = 32
      const cellSize = 10
      const bgColor = '#ccc'
      const fgColor = '#a00'
      const canvas = document.getElementById('cvs')
      const ctx = canvas.getContext('2d')
      canvas.width = width * cellSize
      canvas.height = height * cellSize

      function renderScreen(gfx) {
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        for (let y = 0; y < 32; y++) {
          for (let x = 0; x < width; x++) {
            const pix = gfx[x + width * y]
            ctx.fillStyle = [bgColor, fgColor][pix]
            ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize)
          }
        }
      }

      function loadGame(cb) {
        const fname = "./roms/pong"
        const xhr = new XMLHttpRequest
        xhr.open("GET", fname, true)
        xhr.responseType = "arraybuffer"
        xhr.onload = function () {
          if (xhr.status !== 200) {
            return cb(new Error(`Unable to load ROM. Status code ${xhr.status}`))
          }
          const rom = new Uint8Array(xhr.response)
          loadRom(rom)
          cb()
        }
        xhr.send()
      }

      loadGame(function (err) {
        if (err)
          throw err
        const loop = setInterval(() => {
          try { cycle() }
          catch (err) {
            console.error(err)
            clearInterval(loop)
          }
        }, 60 / 1000)
      })
    </script>
  </body>
</html>
